<style>
    body {
        background-color: var(--figma-color-bg);
        color: var(--figma-color-text);
        font-family:
            Inter,
            ui-sans-serif,
            system-ui,
            -apple-system,
            Segoe UI,
            sans-serif;

        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    html,
    body,
    main,
    div {
        height: 100%;
    }

    main > div {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        gap: 0.7rem;
        text-align: center;
    }

    main > div p {
        margin: 0;
        padding: 0;
    }

    .blink {
        animation: blinker 1s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0;
        }
    }

    button[type='button'] {
        background-color: #555;
        border: solid 1px hsl(0 0% 74% / 1);
        border-radius: 4px;
        color: #fff;
        font-weight: 400;
        cursor: pointer;
        font-size: 1rem;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
    }

    [data-success] {
        background: green;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
    }
</style>
<main>
    <div data-working>
        <p>
            Generating export<span>..<span class="blink">.</span></span>
        </p>
    </div>

    <div data-complete style="display: none">
        <button type="button" data-copy>Copy Export Data</button>
    </div>
    <div data-copied style="display: none">
        <p data-success>Copied!</p>
        <p>Paste into tokens-export.json.</p>
    </div>
    <div data-copied-error style="display: none">
        <p style="color: red">Variable data could not be copied to clipboard.</p>
        <pre></pre>
    </div>
</main>
<script>
    const mainElement = document.querySelector('main');

    let data = null;

    mainElement.querySelector('[data-copy]').onclick = () => {
        command = navigator.clipboard ? navigator.clipboard.writeText : fallbackCopyTextToClipboard;

        command(JSON.stringify(data, null, 4))
            .then(() => {
                mainElement.querySelector('[data-working]').style.display = 'none';
                mainElement.querySelector('[data-complete]').style.display = 'none';
                mainElement.querySelector('[data-copied]').removeAttribute('style');
            })
            .catch((err) => {
                mainElement.querySelector('[data-working]').style.display = 'none';
                mainElement.querySelector('[data-complete]').style.display = 'none';
                mainElement.querySelector('[data-copied-error]').removeAttribute('style');
                mainElement.querySelector('[data-copied-error] pre').textContent = err;
            });
    };

    async function fallbackCopyTextToClipboard(text) {
        // Create a temporary, off-screen textarea element
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        tempInput.style.position = 'absolute';
        tempInput.style.left = '-9999px'; // Move off-screen
        document.body.appendChild(tempInput);

        // Select the text within the textarea
        tempInput.select();
        tempInput.setSelectionRange(0, 9999999999999); // For mobile devices

        try {
            // Execute the copy command
            const successful = document.execCommand('copy');
            return Promise.resolve(successful);
        } catch (err) {
            return Promise.reject(err);
        }

        // Clean up: remove the temporary element
        document.body.removeChild(tempInput);
    }

    window.onmessage = ({ data: { pluginMessage } }) => {
        data = {
            generated: new Date().toISOString(),
            ...pluginMessage.data,
        };

        setTimeout(() => {
            mainElement.querySelector('[data-working]').style.display = 'none';
            mainElement.querySelector('[data-complete]').removeAttribute('style');
        }, 1000);
    };

    setTimeout(() => {
        parent.postMessage({ pluginMessage: { type: 'EXPORT' } }, '*');
    }, 500);
</script>

<!-- Copyright 2025 Anywhere Real Estate - CC BY 4.0 -->
